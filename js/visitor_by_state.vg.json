{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "Packed bubble chart of Malaysia states with linked bar chart showing top 5 visitor countries for the selected state.",
  "width": 1000,
  "height": 600,
  "title": {
    "text": "Tourist States by Visitor Counts",
    "fontSize": 25,
    "font": "Crimson Text",
    "anchor": "middle",
    "fontWeight": "bold"
  },
  "data": [
    {
      "name": "table",
      "url": "./data/visitors_by_state.csv",
      "format": { "type": "csv", "parse": { "TOTAL_VISITORS": "number" } }
    },
    {
      "name": "nodes",
      "source": "table",
      "transform": [
        {
          "type": "nest",
          "keys": []
        },
        {
          "type": "pack",
          "field": "TOTAL_VISITORS",
          "sort": { "field": "TOTAL_VISITORS" },
          "size": [{ "signal": "width / 2" }, { "signal": "height" }],
          "padding": 0
        }
      ]
    },
    {
      "name": "countries",
      "source": "table",
      "transform": [
        { "type": "filter", "expr": "datum.STATE === selectedState" },
        {
          "type": "formula",
          "as": "splitCountries",
          "expr": "split(datum.TOP5_COUNTRIES, '; ')"
        },
        { "type": "flatten", "fields": ["splitCountries"] },
        {
          "type": "formula",
          "as": "country",
          "expr": "trim(replace(datum.splitCountries, /\\s*\\([^)]*\\)/, ''))"
        },
        {
          "type": "formula",
          "as": "value",
          "expr": "parseFloat(replace(datum.splitCountries, /.*\\(([^)]*)\\).*/, '$1'))"
        }
      ]
    }
  ],
  "signals": [
    {
      "name": "selectedState",
      "value": "Johor",
      "on": [
        { "events": "symbol:click, text:click", "update": "datum.STATE" },
        { "events": "dblclick", "update": "null" }
      ]
    }
  ],
  "scales": [
    {
      "name": "color",
      "type": "ordinal",
      "domain": { "data": "table", "field": "STATE" },
      "range": { "scheme": "category20" }
    },
    {
      "name": "xBar",
      "type": "linear",
      "domain": { "data": "countries", "field": "value" },
      "nice": true,
      "range": [0, 400]
    },
    {
      "name": "yBar",
      "type": "band",
      "domain": { "data": "countries", "field": "country" },
      "range": [{ "signal": "height / 4" }, { "signal": "height - 150" }],
      "padding": 0.25
    }
  ],
  "marks": [
    {
      "type": "symbol",
      "from": { "data": "nodes" },
      "encode": {
        "enter": {
          "fill": { "scale": "color", "field": "STATE" },
          "stroke": { "value": "#333" },
          "strokeWidth": { "value": 1 },
          "cursor": { "value": "pointer" },
          "tooltip": {
            "signal": "{'State': datum.STATE, 'Total Visitors (Million)': datum.TOTAL_VISITORS}"
          }
        },
        "update": {
          "x": { "field": "x" },
          "y": { "field": "y" },
          "size": { "signal": "pow(sqrt(datum.TOTAL_VISITORS) * 30, 2)" },
          "fillOpacity": [
            { "test": "datum.STATE === selectedState", "value": 1 },
            { "value": 0.65 }
          ]
        },
        "hover": { "fillOpacity": { "value": 1 } }
      }
    },
    {
      "type": "text",
      "from": { "data": "nodes" },
      "encode": {
        "enter": {
          "text": { "field": "STATE" },
          "align": { "value": "center" },
          "baseline": { "value": "middle" },
          "fontSize": {
            "signal": "clamp(sqrt(datum.TOTAL_VISITORS) * 2.5, 10, 22)"
          },
          "fontWeight": { "value": "bold" },
          "fill": { "value": "white" },
          "cursor": { "value": "pointer" },
          "tooltip": {
            "signal": "{'State': datum.STATE, 'Total Visitors (Million)': datum.TOTAL_VISITORS}"
          }
        },

        "update": {
          "x": { "field": "x" },
          "y": { "field": "y" },
          "fillOpacity": {
            "signal": "datum.STATE.length * 7 < datum.r * 2 ? 1 : 0"
          }
        }
      }
    },

    {
      "type": "group",
      "encode": {
        "enter": {
          "x": { "signal": "width * 0.6" },
          "y": { "signal": "height - 600" },
          "width": { "signal": "width * 0.4" },
          "height": { "signal": "height - 150" }
        }
      },
      "axes": [
        {
          "orient": "bottom",
          "scale": "xBar",
          "title": "Visitors (in Millions)"
        },
        { "orient": "left", "scale": "yBar", "title": "Country" }
      ],
      "marks": [
        {
          "type": "text",
          "encode": {
            "enter": {
              "x": { "signal": "width * 0.2" },
              "y": { "value": 120 },
              "align": { "value": "center" },
              "fontSize": { "value": 16 },
              "fontWeight": { "value": "bold" },
              "fill": { "value": "#333" }
            },
            "update": {
              "text": {
                "signal": "selectedState ? 'Top 5 Visitor Countries for ' + selectedState : 'Click a state bubble'"
              }
            }
          }
        },
        {
          "type": "rect",
          "from": { "data": "countries" },
          "encode": {
            "enter": {
              "x": { "scale": "xBar", "value": 0 },
              "x2": { "scale": "xBar", "field": "value" },
              "y": { "scale": "yBar", "field": "country" },
              "height": { "scale": "yBar", "band": 1 },
              "fill": { "scale": "color", "field": "STATE" },
              "tooltip": {
                "signal": "{'Country': datum.country, 'Visitors (Million)': datum.value}"
              }
            }
          }
        }
      ]
    }
  ]
}
