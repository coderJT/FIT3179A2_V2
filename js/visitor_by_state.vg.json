{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "Interactive bubble chart of total visitors by state in Malaysia with linked bar chart showing top 5 countries for the selected state.",
  "width": 1000,
  "height": 500,
  "padding": 0,
  "title": {
    "text": "Malaysia States by Visitor Count",
    "fontSize": 24,
    "font": "Inter",
    "fontWeight": "bold",
    "offset": 30
  },
  "data": [
    {
      "name": "table",
      "url": "./data/visitors_by_state.csv",
      "format": { "type": "csv", "parse": { "TOTAL_VISITORS": "number" } }
    },
    {
      "name": "nodes",
      "source": "table",
      "transform": [
        {
          "type": "force",
          "iterations": 500,
          "static": true,
          "forces": [
            {
              "force": "center",
              "x": { "signal": "width / 3.5" },
              "y": { "signal": "height / 3" }
            },
            {
              "force": "collide",
              "radius": { "expr": "max(70, sqrt(datum.TOTAL_VISITORS) * 3)" },
              "strength": 0.1
            }
          ]
        }
      ]
    },
    {
      "name": "countries",
      "source": "table",
      "transform": [
        {
          "type": "filter",
          "expr": "datum.STATE === selectedState"
        },
        {
          "type": "formula",
          "as": "splitCountries",
          "expr": "split(datum.TOP5_COUNTRIES, '; ')"
        },
        { "type": "flatten", "fields": ["splitCountries"] },
        {
          "type": "formula",
          "as": "country",
          "expr": "trim(replace(datum.splitCountries, /\\s*\\([^)]*\\)/, ''))"
        },
        {
          "type": "formula",
          "as": "value",
          "expr": "parseFloat(replace(datum.splitCountries, /.*\\(([^)]*)\\).*/, '$1'))"
        }
      ]
    }
  ],

  "signals": [
    {
      "name": "selectedState",
      "value": "Johor",
      "on": [
        { "events": "symbol:click", "update": "datum.STATE" },
        { "events": "dblclick", "update": "null" }
      ]
    }
  ],

  "scales": [
    {
      "name": "color",
      "type": "ordinal",
      "domain": { "data": "table", "field": "STATE" },
      "range": { "scheme": "category20" }
    },
    {
      "name": "xBar",
      "type": "linear",
      "domain": { "data": "countries", "field": "value" },
      "nice": true,
      "range": [0, 300]
    },
    {
      "name": "yBar",
      "type": "band",
      "domain": { "data": "countries", "field": "country" },
      "range": [{ "signal": "height / 5" }, { "signal": "height - 200" }],
      "padding": 0.2
    }
  ],

  "marks": [
    {
      "type": "symbol",
      "from": { "data": "nodes" },
      "encode": {
        "enter": {
          "fill": { "scale": "color", "field": "STATE" },
          "stroke": { "value": "#333" },
          "strokeWidth": { "value": 1 },
          "cursor": { "value": "pointer" },
          "tooltip": {
            "signal": "'State: ' + datum.STATE + '\\nTotal Visitors: ' + datum.TOTAL_VISITORS"
          }
        },
        "update": {
          "x": { "field": "x" },
          "y": { "field": "y" },
          "size": {
            "signal": "pow(max(80, sqrt(datum.TOTAL_VISITORS) * 30), 2)"
          },
          "fillOpacity": [
            { "test": "datum.STATE === selectedState", "value": 1 },
            { "value": 0.6 }
          ]
        },
        "hover": { "fillOpacity": { "value": 1 } }
      }
    },
    {
      "type": "text",
      "from": { "data": "nodes" },
      "encode": {
        "enter": {
          "text": { "field": "STATE" },
          "align": { "value": "center" },
          "baseline": { "value": "middle" },
          "fontSize": {
            "signal": "clamp(sqrt(datum.TOTAL_VISITORS) * 3, 10, 25)"
          },
          "fontWeight": { "value": "bold" },
          "fill": { "value": "white" },
          "cursor": { "value": "pointer" }
        },
        "update": { "x": { "field": "x" }, "y": { "field": "y" } }
      }
    },
    {
      "type": "text",
      "encode": {
        "enter": {
          "x": { "signal": "width * 0.75" },
          "y": { "signal": "height / 15" },
          "fontSize": { "value": 14 },
          "fontWeight": { "value": "bold" },
          "fill": { "value": "#333" }
        },
        "update": {
          "text": {
            "signal": "selectedState ? 'Top 5 Visitor Countries for ' + selectedState : 'Click a state bubble'"
          }
        }
      }
    },
    {
      "type": "group",
      "encode": {
        "enter": {
          "x": { "signal": "width * 0.75" },
          "y": { "signal": "height - 550" },
          "width": { "signal": "width * 0.3" },
          "height": { "signal": "height - 200" }
        }
      },
      "axes": [
        {
          "orient": "bottom",
          "scale": "xBar",
          "title": "Visitors (in Millions)"
        },
        { "orient": "left", "scale": "yBar", "title": "Country" }
      ],
      "marks": [
        {
          "type": "rect",
          "from": { "data": "countries" },
          "encode": {
            "enter": {
              "x": { "scale": "xBar", "value": 0 },
              "x2": { "scale": "xBar", "field": "value" },
              "y": { "scale": "yBar", "field": "country" },
              "height": { "scale": "yBar", "band": 1 },
              "fill": { "scale": "color", "field": "STATE" },
              "tooltip": {
                "signal": "'Country: ' + datum.country + '\\nVisitors: ' + datum.value"
              }
            }
          }
        }
      ]
    }
  ]
}
